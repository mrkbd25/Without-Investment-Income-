<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taka Income Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- ********************************************************** -->
    <!--  à¦¨à¦¿à¦šà§‡ MONETAG à¦à¦° à¦¸à§à¦•à§à¦°à¦¿à¦ªà§à¦Ÿ à¦¬à¦¸à¦¾à¦¨ (Vignette / Interstitial)  -->
    <!-- ********************************************************** -->
    
    <!-- à¦‰à¦¦à¦¾à¦¹à¦°à¦£: <script src="https://alwingulla.com/88/tag.min.js" data-zone="123456" async data-cfasync="false"></script> -->
    
    <!-- à¦†à¦ªà¦¨à¦¾à¦° à¦†à¦¸à¦² à¦¸à§à¦•à§à¦°à¦¿à¦ªà§à¦Ÿ à¦à¦–à¦¾à¦¨à§‡ à¦ªà§‡à¦¸à§à¦Ÿ à¦•à¦°à§à¦¨ -->
    
    
    <!-- ********************************************************** -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        (function() {
            try {
                const tg = window.Telegram.WebApp;
                tg.expand();
                document.documentElement.setAttribute('data-theme', 'dark');
                tg.setHeaderColor('#000000');
                tg.setBackgroundColor('#000000');
            } catch (e) { console.log(e); }
        })();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        :root { --bg-body: #050505; --primary-color: #F0B90B; --glass-bg: rgba(20, 20, 20, 0.7); --glass-border: rgba(255, 255, 255, 0.08); --card-gradient: linear-gradient(145deg, rgba(30,30,30,0.9) 0%, rgba(10,10,10,0.95) 100%); --balance-gradient: linear-gradient(135deg, #1e1e1e 0%, #000000 100%); --text-main: #ffffff; --text-sub: #888888; }
        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; margin: 0; padding: 20px 20px 120px 20px; background-color: var(--bg-body); background-image: radial-gradient(circle at 50% -20%, #1a1a1a, #000000); color: var(--text-main); overflow-x: hidden; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-ring { width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        #preloader-percentage { margin-top: 15px; font-weight: 700; color: var(--primary-color); }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        #profile-pic { width: 48px; height: 48px; border-radius: 12px; border: 1px solid var(--glass-border); overflow: hidden; background: #222; display: flex; justify-content: center; align-items: center; }
        #profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .user-texts h1 { font-size: 18px; margin: 0; font-weight: 600; }
        .user-texts span { font-size: 12px; color: var(--primary-color); background: rgba(240, 185, 11, 0.1); padding: 2px 8px; border-radius: 4px; font-weight: 500; letter-spacing: 1px; }
        .balance-card { position: relative; background: var(--balance-gradient); padding: 25px; border-radius: 24px; border: 1px solid #333; box-shadow: 0 20px 40px rgba(0,0,0,0.6); overflow: hidden; margin-bottom: 25px; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; }
        .balance-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); animation: shine 5s infinite; }
        .balance-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .balance-label { font-size: 13px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .binance-brand { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; z-index: 10; }
        .binance-brand:active { transform: scale(0.95); background: rgba(240, 185, 11, 0.2); }
        .binance-brand svg { width: 24px; height: 24px; }
        .binance-brand span { font-weight: 700; font-size: 14px; color: #FFF; letter-spacing: 0.5px; }
        .amount { font-size: 38px; font-weight: 700; color: white; margin-top: 10px; display: block; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .currency-symbol { color: var(--primary-color); }
        .balance-bottom { margin-top: 20px; display: flex; gap: 10px; }
        .chip { background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px; font-size: 10px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .stat-item { background: var(--card-gradient); padding: 15px 10px; border-radius: 18px; text-align: center; border: 1px solid var(--glass-border); }
        .stat-item .icon { font-size: 20px; margin-bottom: 8px; color: var(--primary-color); }
        .stat-item .value { font-size: 16px; font-weight: 700; display: block; color: #fff; }
        .stat-item .label { font-size: 10px; color: var(--text-sub); text-transform: uppercase; }
        .card { background: var(--card-gradient); padding: 20px; border-radius: 24px; margin-bottom: 20px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #ddd; }
        .card-title i { color: var(--primary-color); }
        .action-button { width: 100%; padding: 16px; border: none; border-radius: 16px; background: var(--primary-color); color: black; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(240, 185, 11, 0.3); text-transform: uppercase; letter-spacing: 0.5px; }
        .action-button:active { transform: scale(0.97); }
        .secondary-button { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); margin-top: 12px; box-shadow: none; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; max-width: 460px; margin: 0 auto; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; }
        .nav-button { background: transparent; border: none; color: #666; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 10px; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .nav-button.active { color: var(--primary-color); }
        .nav-button.active i { transform: translateY(-3px); text-shadow: 0 0 10px rgba(240,185,11,0.5); }
        .nav-button.center-btn { position: relative; top: -30px; background: var(--primary-color); width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(240, 185, 11, 0.4); border: 5px solid var(--bg-body); color: black !important; }
        .nav-button.center-btn i { font-size: 24px; }

        /* MODAL STYLES UPDATED */
        .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: flex-end; /* Default for others */ }
        
        /* Center Modal Class for Welcome/Notice */
        .modal.center-modal { align-items: center; justify-content: center; }
        .modal.center-modal .modal-content { border-radius: 24px; margin: 0 20px; animation: scaleUp 0.3s ease; max-width: 400px; width: 90%; }

        .modal-content { background-color: #111; padding: 30px 25px; border-radius: 30px 30px 0 0; width: 100%; max-width: 500px; margin: 0 auto; border-top: 1px solid var(--primary-color); color: white; animation: slideUp 0.3s ease; }
        .modal-content input, .modal-content select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #333; border-radius: 12px; background: #050505; color: white; font-family: 'Outfit', sans-serif; }
        .modal-content input:focus { border-color: var(--primary-color); outline: none; }
        
        @keyframes shine { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pulsing { animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(240, 185, 11, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(240, 185, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(240, 185, 11, 0); } }
        .history-item { padding: 15px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        .status-pending { background: rgba(255, 165, 0, 0.2); color: orange; }
        .status-success { background: rgba(0, 255, 0, 0.2); color: #00ff88; }
        #ad-loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center; flex-direction: column; color: white; gap: 15px; }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader-ring"></div><div id="preloader-percentage">0%</div></div>
    <div id="ad-loader-overlay"><div class="loader-ring"></div><span>Checking Ad...</span></div>
    
    <div class="container" style="max-width: 500px; margin: 0 auto; display: none;">
        <!-- Header -->
        <div class="header-section">
            <div class="profile-info">
                <div id="profile-pic"><i class="fa-solid fa-user" style="color:#666;"></i></div>
                <div class="user-texts"><h1 id="greeting">Hi, Trader</h1><span>PREMIUM PLUS</span></div>
            </div>
            <div onclick="showModal('welcomeModal')" style="padding:10px; background:#222; border-radius:12px; cursor:pointer;"><i class="fa-regular fa-bell" style="color:white;"></i></div>
        </div>

        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-top">
                <div><span class="balance-label">Total Asset</span><span class="amount" id="total-earning"><span class="currency-symbol">$</span>0.000</span></div>
                <div class="binance-brand" onclick="openExternalLink('https://www.binance.com/activity/referral-entry/CPA?ref=CPA_00RPJ64DBN')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="#F0B90B" d="M16 0L9.12 6.88l6.88 6.88 6.88-6.88L16 0zm-9.76 9.76L0 16l6.24 6.24 6.24-6.24-6.24-6.24zm19.52 0L19.52 16l6.24 6.24L32 16l-6.24-6.24zM16 19.52l-6.88 6.88L16 32l6.88-6.88-6.88-6.88z"/></svg>
                    <span>BINANCE</span><i class="fa-solid fa-arrow-up-right-from-square" style="font-size:10px; color:#aaa; margin-left:3px;"></i>
                </div>
            </div>
            <div class="balance-bottom"><div class="chip"><i class="fa-brands fa-bitcoin" style="color:#F7931A"></i> Crypto</div><div class="chip"><i class="fa-solid fa-shield-halved" style="color:#00ff88"></i> Secured</div></div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-item"><div class="icon"><i class="fa-solid fa-play"></i></div><span class="value" id="ad-count">0</span><span class="label">Ads</span></div>
            <div class="stat-item"><div class="icon"><i class="fa-solid fa-chart-pie"></i></div><span class="value" id="ads-today-count">0 / 15</span><span class="label">Limit</span></div>
            <div class="stat-item" onclick="showModal('inviteModal')"><div class="icon"><i class="fa-solid fa-users"></i></div><span class="value" id="referral-count">0</span><span class="label">Team</span></div>
        </div>

        <!-- Task Section -->
        <div class="card">
            <div class="card-title"><i class="fa-solid fa-layer-group"></i> Quick Tasks</div>
            <button class="action-button" id="watch-ad-button"><i class="fa-solid fa-circle-play"></i><span>Watch & Earn</span></button>
            <button class="action-button secondary-button" id="join-channel-button"><i class="fa-brands fa-telegram"></i><span>Join Official Channel</span></button>
        </div>

        <!-- Chart Section -->
        <div class="card"><div class="card-title"><i class="fa-solid fa-chart-line"></i> Analytics</div><div class="chart-container"><canvas id="activityChart"></canvas></div></div>
    </div>

    <!-- Nav Bar -->
    <div class="nav-bar">
        <button class="nav-button" onclick="showModal('withdrawModal', this)"><i class="fa-solid fa-wallet"></i><span>Wallet</span></button>
        <button class="nav-button" onclick="showModal('historyModal', this)"><i class="fa-solid fa-clock-rotate-left"></i><span>History</span></button>
        <button class="nav-button center-btn" onclick="showModal('inviteModal', this)"><i class="fa-solid fa-user-plus"></i></button>
        <button class="nav-button" onclick="showModal('bonusTasksModal', this)"><i class="fa-solid fa-gift"></i><span>Bonus</span></button>
        <button class="nav-button" onclick="showModal('supportModal', this)"><i class="fa-solid fa-headset"></i><span>Support</span></button>
    </div>
    
    <!-- Modals -->
    <!-- WELCOME MODAL: CENTERED -->
    <div id="welcomeModal" class="modal center-modal">
        <div class="modal-content" style="text-align: center;">
            <i class="fa-solid fa-crown" style="font-size: 40px; color: var(--primary-color); margin-bottom: 15px;"></i>
            <h3 class="card-title" id="welcome-title" style="justify-content: center; margin-bottom: 10px;">Premium Rules</h3>
            <p id="welcome-message" style="line-height: 1.6; color: #ccc; font-size: 14px; margin-bottom: 20px;"></p>
            <button class="action-button" onclick="closeModal('welcomeModal')">Accept & Start</button>
        </div>
    </div>

    <div id="withdrawModal" class="modal"><div class="modal-content"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h3 class="card-title" style="margin:0">Withdraw Funds</h3><span onclick="closeModal('withdrawModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><p id="min-withdraw-text" style="color:var(--primary-color); font-size:13px; margin-bottom:15px;"></p><form id="withdraw-form"><select id="method" name="method" required><option value="" disabled selected>Select Method</option></select><input type="text" id="account-number" placeholder="Wallet Address / Number" required><input type="number" step="0.001" id="withdraw-amount" placeholder="Amount (USD)" required><button type="submit" class="action-button" id="withdraw-submit-button"><span class="button-text">Confirm Withdraw</span><div class="spinner" style="display: none; width:20px; height:20px; border:3px solid black; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite;"></div></button></form></div></div>
    <div id="inviteModal" class="modal"><div class="modal-content"><span style="float:right; font-size:24px; cursor:pointer;" onclick="closeModal('inviteModal')">&times;</span><h3 class="card-title" style="justify-content:center; color:white;">Invite Friends</h3><div style="background:rgba(240, 185, 11, 0.1); padding:20px; border-radius:15px; text-align:center; margin-bottom:20px; border:1px dashed var(--primary-color);"><span style="font-size:14px; color:#aaa;">Bonus per Invite</span><span style="font-size:32px; font-weight:800; color:var(--primary-color); display:block; margin:5px 0;">$0.01</span><span style="font-size:12px; color:#aaa;">Instant Credit</span></div><button class="action-button" id="copy-link-button"><i class="fa-solid fa-copy"></i> Copy Link</button><button class="action-button secondary-button" id="share-link-button"><i class="fa-solid fa-share-nodes"></i> Share</button></div></div>
    <div id="supportModal" class="modal"><div class="modal-content"><span style="float:right; cursor:pointer;" onclick="closeModal('supportModal')">&times;</span><h3 class="card-title">Support Center</h3><button class="action-button" id="admin-contact-button"><i class="fa-brands fa-telegram"></i> Message Support</button></div></div>
    <div id="historyModal" class="modal"><div class="modal-content"><span style="float:right; cursor:pointer;" onclick="closeModal('historyModal')">&times;</span><h3 class="card-title">Transactions</h3><div id="history-list"></div></div></div>
    <div id="bonusTasksModal" class="modal"><div class="modal-content"><span style="float:right; cursor:pointer;" onclick="closeModal('bonusTasksModal')">&times;</span><h3 class="card-title">Bonus Zone</h3><div id="bonus-tasks-list"></div></div></div>
    
    <!-- Multi Account Error Modal -->
    <div id="multiAccountModal" class="modal center-modal" style="display: none; z-index: 9999;">
        <div class="modal-content" style="text-align:center; border: 1px solid red;">
            <i class="fa-solid fa-ban" style="font-size:50px; color:red; margin-bottom:15px;"></i>
            <h3 style="color: red; margin-bottom: 10px;">Access Denied</h3>
            <p style="color: #ccc; margin-bottom: 20px;">Multiple accounts are not allowed on this device.</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const config = {
            // MONETAG SCRIPT IS IN THE HEAD SECTION NOW
            
            BOT_TOKEN: '7716639611:AAEg5zkgfjCrTiM3ryCC68Yq8QoIWjZwwlI', 
            ADMIN_IDS: [7383787169],
            BOT_USERNAME: 'simpletasktg_bot',
            TELEGRAM_CHANNEL_LINK: 'https://t.me/withoutinvestmenttgchannel',
            ADMIN_SUPPORT_LINK: 'https://t.me/+a9F0enpHIb8wYjc9',
            AD_REWARD: 0.001,
            DAILY_AD_LIMIT: 15,
            MINIMUM_WITHDRAWAL: 5.00,
            COOLDOWN_MINUTES: 60,
            withdrawalMethods: ['Binance Pay ID','Bkash'],
            firebase: { apiKey: "AIzaSyDIclnY0Xi-2Xsg8vvNUbX_cJRmt1wI7Ks", authDomain: "withoutinvestment-82782.firebaseapp.com", databaseURL: "https://withoutinvestment-82782-default-rtdb.firebaseio.com", projectId: "withoutinvestment-82782", storageBucket: "withoutinvestment-82782.firebasestorage.app", messagingSenderId: "955413852152", appId: "1:955413852152:web:872486ffbbbce91797f00d" },
            REFERRAL_REWARD: 0.01,
            bonusTasks: [
                { id: 'bonus_01', title: 'Join Alert Channel', link: 'https://t.me/developer_rk01', reward: 0.02, duration: 10 },
                { id: 'bonus_02', title: 'Claim Red Packet', link: 'https://t.me/binance_redpacket0', reward: 0.01, duration: 10 }
            ],
            welcomeNotice: { title: "Premium Rules", message: `â€¢ Rate: $0.001 / Ad\nâ€¢ Refer: $0.01 / Friend\nâ€¢ Min Withdraw: $5.00\n\nRULES:\n1. Only one account per device.\n2. Do not use VPN/Proxy.\n3. Click "Accept" to start.` }
        };

        const tg = window.Telegram ? window.Telegram.WebApp : null;
        let state = { totalEarning: 0.0, adCount: 0, adsWatchedToday: 0, lastAdWatchedDate: null, cooldownUntil: null, weeklyActivity: [0, 0, 0, 0, 0, 0, 0], withdrawalHistory: [], lastUsedIp: null, completedBonusTasks: [], rewardedReferrals: 0 };
        const dbName = 'ProAppDB'; let db; let currentIpAddress = null; let firebaseApp, firebaseDb;
        const el = { preloader: document.getElementById('preloader'), container: document.querySelector('.container'), totalEarning: document.getElementById('total-earning'), adCount: document.getElementById('ad-count'), adsToday: document.getElementById('ads-today-count'), refCount: document.getElementById('referral-count'), watchBtn: document.getElementById('watch-ad-button'), withdrawForm: document.getElementById('withdraw-form'), adOverlay: document.getElementById('ad-loader-overlay'), profilePic: document.getElementById('profile-pic'), greeting: document.getElementById('greeting'), joinChannel: document.getElementById('join-channel-button'), adminContact: document.getElementById('admin-contact-button'), historyList: document.getElementById('history-list'), bonusList: document.getElementById('bonus-tasks-list') };

        function initDB() { return new Promise((resolve) => { try { const request = indexedDB.open(dbName, 3); request.onerror = () => resolve(); request.onsuccess = e => { db = e.target.result; resolve(); }; request.onupgradeneeded = e => { let db = e.target.result; if (!db.objectStoreNames.contains('userState')) db.createObjectStore('userState', { keyPath: 'id' }); if (!db.objectStoreNames.contains('appUsage')) db.createObjectStore('appUsage', { keyPath: 'ip' }); }; } catch { resolve(); } }); }
        function saveState() { if (!db) return; const tx = db.transaction(['userState'], 'readwrite'); tx.objectStore('userState').put({ id: 'currentUser', ...state }); }
        function loadState() { return new Promise(resolve => { if (!db) return resolve(); const req = db.transaction(['userState'], 'readonly').objectStore('userState').get('currentUser'); req.onsuccess = () => { if (req.result) state = { ...state, ...req.result }; if(!state.completedBonusTasks) state.completedBonusTasks=[]; if (state.lastAdWatchedDate !== new Date().toLocaleDateString()) { state.adsWatchedToday = 0; state.lastAdWatchedDate = new Date().toLocaleDateString(); } resolve(); }; req.onerror = () => resolve(); }); }
        async function getIpAddress() { try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); return d.ip; } catch { return '0.0.0.0'; } }
        
        // --- DEVICE CHECK LOGIC ---
        function checkDeviceRestriction(currentUserId) {
            return new Promise(async (resolve) => {
                const storedUser = localStorage.getItem('registered_uid');
                if (storedUser && storedUser != currentUserId) {
                    console.log('Multi-account detected via LocalStorage');
                    resolve(true); 
                    return;
                }
                const ip = await getIpAddress();
                currentIpAddress = ip;
                
                if (!db) { resolve(false); return; }
                const r = db.transaction(['appUsage'], 'readonly').objectStore('appUsage').get(ip);
                r.onsuccess = () => {
                    if (r.result && !storedUser) {
                        resolve(true); 
                    } else {
                        if(!storedUser) {
                            localStorage.setItem('registered_uid', currentUserId);
                            db.transaction(['appUsage'], 'readwrite').objectStore('appUsage').put({ ip: ip, date: new Date().toISOString() });
                        }
                        resolve(false);
                    }
                };
                r.onerror = () => resolve(false);
            });
        }

        function safeTgAction(action) { if (tg && tg.initData) action(tg); }
        function safeAlert(msg) { safeTgAction(t => t.showAlert(msg)); if(!tg.initData) alert(msg); }
        
        // UPDATED LINK OPENER FOR TELEGRAM MINI APP
        function openExternalLink(url) { 
            if(tg && tg.openLink) {
                tg.openLink(url); 
            } else {
                window.open(url, '_blank'); 
            }
        }

        let cooldownInterval;
        function updateUI() {
            if (state.cooldownUntil && new Date() >= new Date(state.cooldownUntil)) { state.cooldownUntil = null; state.adsWatchedToday = 0; saveState(); }
            el.totalEarning.innerHTML = `<span class="currency-symbol">$</span>${state.totalEarning.toFixed(3)}`; el.adCount.textContent = state.adCount; el.adsToday.textContent = `${state.adsWatchedToday} / ${config.DAILY_AD_LIMIT}`; document.getElementById('min-withdraw-text').textContent = `Minimum Withdrawal: $${config.MINIMUM_WITHDRAWAL}`;
            clearInterval(cooldownInterval);
            if (state.cooldownUntil && new Date() < new Date(state.cooldownUntil)) {
                el.watchBtn.disabled = true; el.watchBtn.style.opacity = '0.5';
                const updateTimer = () => { const remaining = new Date(state.cooldownUntil) - new Date(); if (remaining <= 0) { clearInterval(cooldownInterval); state.cooldownUntil = null; state.adsWatchedToday = 0; saveState(); updateUI(); } else { const m = Math.floor((remaining/1000/60)%60); const s = Math.floor((remaining/1000)%60); el.watchBtn.querySelector('span').textContent = `Cooldown: ${m}m ${s}s`; } };
                cooldownInterval = setInterval(updateTimer, 1000); updateTimer();
            } else { el.watchBtn.disabled = state.adsWatchedToday >= config.DAILY_AD_LIMIT; el.watchBtn.style.opacity = '1'; el.watchBtn.querySelector('span').textContent = state.adsWatchedToday >= config.DAILY_AD_LIMIT ? 'Limit Reached' : 'Watch & Earn'; }
            if(!el.watchBtn.disabled) el.watchBtn.classList.add('pulsing'); else el.watchBtn.classList.remove('pulsing');
            updateChart();
        }

        // --- UPDATED WATCH AD FUNCTION (NO DIRECT LINK) ---
        async function watchAd() {
            // Check IP & Cooldown
            if (state.lastUsedIp && !state.cooldownUntil) {
                 const newIp = await getIpAddress();
                 if (newIp === state.lastUsedIp) { safeAlert('Please change IP (Airplane Mode ON/OFF).'); return; } 
                 state.lastUsedIp = null; saveState();
            }

            // Button Disable & Loading Effect
            el.watchBtn.disabled = true;
            el.watchBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading Ad...';

            // Show Overlay (Makes users wait for the ad script to load)
            el.adOverlay.style.display = 'flex';
            el.adOverlay.querySelector('span').innerText = "Please watch the ad...";

            // Wait 10 seconds for the ad script (Vignette/Interstitial) to show and complete
            // This replaces the direct link opening.
            setTimeout(() => {
                el.adOverlay.style.display = 'none';
                
                // Add Reward
                state.totalEarning += config.AD_REWARD; 
                state.adCount++; 
                state.adsWatchedToday++; 
                state.weeklyActivity[new Date().getDay()]++;
                
                // Check Limit
                if (state.adsWatchedToday >= config.DAILY_AD_LIMIT) {
                    const cd = new Date(); cd.setMinutes(cd.getMinutes() + config.COOLDOWN_MINUTES);
                    state.cooldownUntil = cd.toISOString(); state.lastUsedIp = currentIpAddress;
                }
                
                saveState(); 
                updateUI();
                safeTgAction(t => t.HapticFeedback.notificationOccurred('success'));
                
                // Reset Button
                if (state.adsWatchedToday < config.DAILY_AD_LIMIT) {
                     el.watchBtn.innerHTML = '<i class="fa-solid fa-circle-play"></i><span>Watch & Earn</span>';
                     el.watchBtn.disabled = false;
                }
            }, 10000); // 10 Seconds Wait
        }

        async function handleWithdrawal(e) {
            e.preventDefault(); const amt = parseFloat(el.withdrawForm['withdraw-amount'].value); const method = el.withdrawForm['method'].value; const acc = el.withdrawForm['account-number'].value;
            if (amt > state.totalEarning) return safeAlert('Insufficient funds.'); if (amt < config.MINIMUM_WITHDRAWAL) return safeAlert(`Min withdraw: $${config.MINIMUM_WITHDRAWAL}`);
            const btn = document.getElementById('withdraw-submit-button'); btn.disabled = true; btn.querySelector('.spinner').style.display='block'; btn.querySelector('.button-text').style.display='none';
            const user = tg ? tg.initDataUnsafe?.user : { first_name: 'Test', id: '000' }; const msg = `<b>ðŸ’¸ Payout Request</b>\nUser: ${user.first_name}\nID: <code>${user.id}</code>\nMethod: ${method}\nWallet: <code>${acc}</code>\nAmount: $${amt}`;
            try { await Promise.all(config.ADMIN_IDS.map(id => fetch(`https://api.telegram.org/bot${config.BOT_TOKEN}/sendMessage`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: id, text: msg, parse_mode: 'HTML' }) }))); state.totalEarning -= amt; state.withdrawalHistory.unshift({ method, amount: amt, date: new Date().toISOString(), status: 'Pending' }); saveState(); updateUI(); closeModal('withdrawModal'); safeAlert('Withdrawal Submitted!'); } catch { safeAlert('Connection Error.'); } finally { btn.disabled = false; btn.querySelector('.spinner').style.display='none'; btn.querySelector('.button-text').style.display='block'; }
        }

        function updateChart() { const ctx = document.getElementById('activityChart').getContext('2d'); if(window.myChart) window.myChart.destroy(); const gradient = ctx.createLinearGradient(0,0,0,300); gradient.addColorStop(0, 'rgba(240, 185, 11, 0.5)'); gradient.addColorStop(1, 'rgba(240, 185, 11, 0.0)'); window.myChart = new Chart(ctx, { type: 'line', data: { labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ label: 'Ads', data: state.weeklyActivity, borderColor: '#F0B90B', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor:'#fff' }] }, options: { scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#666' } } }, plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false } }); }
        function showModal(id) { if(id === 'historyModal') renderHistory(); if(id === 'bonusTasksModal') renderBonus(); document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function renderHistory() { el.historyList.innerHTML = state.withdrawalHistory.length ? state.withdrawalHistory.map(i => `<div class="history-item"><div><span style="font-weight:600;color:white;">${i.method}</span><br><span style="font-size:10px;color:#666;">${new Date(i.date).toLocaleDateString()}</span></div><div style="text-align:right;"><span style="color:#F0B90B;font-weight:bold;">$${i.amount.toFixed(3)}</span><br><span class="status-badge ${i.status === 'Pending' ? 'status-pending' : 'status-success'}">${i.status}</span></div></div>`).join('') : '<p style="text-align:center;color:#666;">No transactions yet.</p>'; }
        
        function renderBonus() {
            el.bonusList.innerHTML = config.bonusTasks.map(t => {
                const done = state.completedBonusTasks.includes(t.id);
                return `<div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;"><div><span style="color:white;font-weight:600;">${t.title}</span><br><span style="color:#F0B90B;font-size:12px;">+$${t.reward}</span></div><button style="background:${done?'#222':'var(--primary-color)'}; color:${done?'#666':'#000'}; border:none; padding:8px 16px; border-radius:8px; font-weight:bold;" ${done?'disabled':''} onclick="doBonus('${t.id}')">${done?'Done':'Claim'}</button></div>`
            }).join('');
        }
        window.doBonus = (id) => { const task = config.bonusTasks.find(t => t.id === id); openExternalLink(task.link); const btn = event.target; btn.innerText = "Checking..."; btn.disabled = true; setTimeout(() => { if(!state.completedBonusTasks.includes(id)) { state.totalEarning += task.reward; state.completedBonusTasks.push(id); saveState(); updateUI(); renderBonus(); safeAlert('Bonus Claimed Successfully!'); } }, task.duration * 1000); };

        async function initApp() {
            const select = document.getElementById('method'); config.withdrawalMethods.forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; select.appendChild(o); });
            document.getElementById('welcome-title').textContent = config.welcomeNotice.title; document.getElementById('welcome-message').innerText = config.welcomeNotice.message;
            await initDB(); await loadState();
            
            const userId = tg?.initDataUnsafe?.user?.id || 'guest_' + Math.floor(Math.random()*100000);
            
            // --- CHECK MULTI ACCOUNT ---
            const isBlocked = await checkDeviceRestriction(userId);
            if(isBlocked) {
                document.getElementById('multiAccountModal').style.display = 'flex';
                el.preloader.style.display = 'none';
                return; // Stop app loading
            }
            
            try { firebase.initializeApp(config.firebase); firebaseDb = firebase.database(); if(tg?.initDataUnsafe?.user) { const uid = tg.initDataUnsafe.user.id; const refId = parseInt(tg.initDataUnsafe.start_param); if(refId && refId !== uid) { firebaseDb.ref(`users/${uid}/referred_by`).once('value', s => { if(!s.exists()) { firebaseDb.ref(`users/${uid}/referred_by`).set(refId); firebaseDb.ref(`users/${refId}/referrals`).transaction(c => (c||0)+1); }}); } firebaseDb.ref(`users/${uid}/referrals`).on('value', s => { const c = s.val()||0; el.refCount.textContent = c; if(c > state.rewardedReferrals) { state.totalEarning += (c - state.rewardedReferrals)*config.REFERRAL_REWARD; state.rewardedReferrals = c; saveState(); updateUI(); safeAlert('Referral Bonus Added!'); } }); } } catch(e) { console.log('Firebase Error', e); }
            if(tg?.initDataUnsafe?.user) { const u = tg.initDataUnsafe.user; el.greeting.textContent = `Hi, ${u.first_name}`; if(u.photo_url) el.profilePic.innerHTML = `<img src="${u.photo_url}">`; }
            el.watchBtn.onclick = watchAd; el.withdrawForm.onsubmit = handleWithdrawal; el.joinChannel.onclick = () => openExternalLink(config.TELEGRAM_CHANNEL_LINK); el.adminContact.onclick = () => openExternalLink(config.ADMIN_SUPPORT_LINK);
            const getRefLink = () => `https://t.me/${config.BOT_USERNAME}?startapp=${tg?.initDataUnsafe?.user?.id || 'user'}`; document.getElementById('copy-link-button').onclick = () => { navigator.clipboard.writeText(getRefLink()); safeAlert('Link Copied!'); }; document.getElementById('share-link-button').onclick = () => { if(tg) tg.openTelegramLink(`https://t.me/share/url?url=${getRefLink()}&text=Join and Earn!`); };
            updateUI(); setTimeout(() => { el.preloader.style.display='none'; el.container.style.display='block'; updateChart(); showModal('welcomeModal'); }, 1500);
        }
        window.onload = initApp;
    </script>
</body>
                                                                          </html>
